name: Test, render gallery, and deploy to Pages

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  issues: write

jobs:
  unit-tests:
    name: d3figurer unit tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Make scripts executable
        run: chmod +x d3figurer/server.sh d3figurer/test.sh

      - name: Install dependencies (skip Chrome — not needed for unit tests)
        run: PUPPETEER_SKIP_DOWNLOAD=true npm install --prefix d3figurer

      - name: Run unit tests
        run: d3figurer/test.sh -v

  build-and-deploy:
    name: Render gallery and deploy to Pages
    needs: [unit-tests]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    concurrency:
      group: "pages"
      cancel-in-progress: false
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Make scripts executable
        run: chmod +x d3figurer/server.sh d3figurer/mcp.sh d3figurer/setup_mcp.sh d3figurer/test.sh

      - name: Install d3figurer dependencies
        run: d3figurer/server.sh install

      - name: Start render server
        run: d3figurer/server.sh start --src-dir d3figurer/gallery

      - name: Render gallery
        run: |
          NODE_PATH="$HOME/.d3figurer-work/d3figurer/node_modules" \
          node d3figurer/bin/d3figurer.js batch d3figurer/gallery \
            --src-dir d3figurer/gallery

      - name: Stop render server
        if: always()
        run: d3figurer/server.sh stop

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'd3figurer/gallery/output'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  open-issue-on-failure:
    name: Open issue on failure
    needs: [unit-tests, build-and-deploy]
    if: always() && (needs.unit-tests.result == 'failure' || needs.build-and-deploy.result == 'failure') && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const shortSha = context.sha.slice(0, 7);
            const title = 'CI failing on main';

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              creator: 'github-actions[bot]',
            });
            const existing = issues.find(i => i.title === title);

            if (existing) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body: `Still failing: [run ${context.runId}](${runUrl}) — commit \`${shortSha}\``,
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body: [
                  '## CI is failing on `main`',
                  '',
                  `First detected: [run ${context.runId}](${runUrl}) — commit \`${shortSha}\``,
                  '',
                  'Fix the failing job and close this issue.',
                ].join('\n'),
              });
            }
